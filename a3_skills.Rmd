---
title: "Skills for Analysis Assignment 3"
author: "GSD SES 5394"
date: "Spring 2022"
output: 
  rmdformats::material
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

The followings skills will be useful for Analysis Assignment 3. They are listed here alphabetically. I don't want to bias your thinking about which ones you'll end up using and in what order. But this page will be a useful reference.

*Note: In general, you should load all your libraries at the beginning of your script or markdown file. In these examples, I'm loading libraries at the top of each code chunk to make it more clear which methods use which packages.*

* **Compare skims**:

* **Convert an OSM file to a PBF file**: You will be downloading OpenStreetMap data (and potentially editing it) in the \*.osm file format. To use it with the the the r5r package, you'll need to convert it to a \*.pbf file (which is just a compressed version of the \*.osm file).

* **Download an OpenStreetMap network**: You'll need to represent the existing roadway network in a format that will allow you to calculate travel times. OpenStreetMaps is helpful for this.

* **Download a GTFS feed**: You'll need to download data on the transit network in the GTFS format. There are a couple places you can look for that data.

* **Edit an OpenStreetMap network**: If the alternative you want to evaluate involves changes to the road network, you'll need to save a copy of the existing OpenStreetMap network you downloaded (see the "Download and OpenStreetMap network" topic), and prepare it for editing (see the "Prepare an OpenStreetMap network for editing" topic).

* **Edit transit route frequency**:

* **Generate skims**:

* **Install a package from GitHub**: If you want to edit the the transit network or the street network, you'll find the `scenRios` package useful. This is a package I wrote specifically for this class (like, yesterday), and it's still very much in beta. You'll need to install it from GitHub (this is common for beta versions of new or updated packages).

* **Prepare an OpenStreetMap network for editing**: The OSM file you download from the Overpass API (see the "Download an OpenStreetMap network" topic) will not include version tags, but to edit the file using JOSM (see the "Edit an OpenStreetMap network" topic), you'll need to have those.

* **View GTFS routes**:

* **View GTFS service plans**:

# Compare skims

# Convert an OSM file to a PBF file

You will be downloading OpenStreetMap data (and potentially editing it) in the \*.osm file format. To use it with the the the r5r package, you'll need to convert it to a \*.pbf file (which is just a compressed version of the \*.osm file). 

On a PC, you can use the osmconvert executable that you'll find in your GitHub repo to do that. [Here's a video that shows how](https://harvard.zoom.us/rec/play/wQDI6cjRC98bESyWY9sWk0HaEaBm0gSfvajrd2VuoqOUhavIDB-PKrf8rczEn0iQBqVcIGRNrxnuJSL2.SFOMASsvYsb7kTR3?autoplay=true&startTime=1643906867000){target="_blank"}.

On a Mac, you can use a program called osmium, which you'll need to install using Homebrew (which likely means you'll also need to install Homebrew). [Here's a video that shows how to do all that](https://harvard.zoom.us/rec/play/vw9e3HQzIZt5ki-jHUobTkL39B-SlXOKWVv7XG73xCbwODK7-PdxsxKcJblgA3F87wufYMcC2nY22rGh.Odv9oMq-y-2oDJMC?autoplay=true&startTime=1643665132000){target="_blank"}.

# Download an OpenStreetMap network

You'll need to represent the existing roadway network in a format that will allow you to calculate travel times. OpenStreetMaps is helpful for this. 

The `osmdata` package includes functions to build a queries to request data from the [Overpass API](https://wiki.openstreetmap.org/wiki/Overpass_API) within a defined bounding box.

First you'll need to use the `st_bbox()` function to define the bounding box based on the boundary of your study area. 

Then you can use the `opq()` function to request OpenStreetMap data within that bounding box. `add_osm_feature()` lets you specify which types of features you want to request. By setting `key = 'highway'`, you indicate that you want all the roads (OpenStreetMaps refers to all roads, including pedestrian paths, as [highways](https://wiki.openstreetmap.org/wiki/Key:highway)). Finally, you can use `osmdata_xml()` to download and save the data you've requested to an OSM file.

```{r, eval=FALSE}
library(sf)
library(tigris)
library(tidyverse)
library(osmdata)

# Load the MSA boundaries
boundary <- core_based_statistical_areas() %>%
  filter(GEOID == "40060")

# Define a bounding box containing the MSA
richmond_bbox <- st_bbox(boundary)

q <- opq(bbox = richmond_bbox) %>% # create a query
  add_osm_feature(key = 'highway') %>% # request only road data
  osmdata_xml(file = 'existing/networks/streets.osm') # download osm file
```

# Download a GTFS feed

You'll need to download data on the transit network in the GTFS format. There are a couple places you can look for that data.

[OpenMobilityData](transitfeeds.com){target="_blank"} maintains a pretty good archive of GTFS feeds for cities throughout the world. You'll likely by able to find the GTFS feeed for the transit agency serving your study area there. Download it, and save it to the `networks` subfolder in the `existing` folder of your project directory. It will be a zipped file. No need to unzip (what I really mean is, please don't unzip it).

You can also use the tidytransit package to find the GTFS feed you want. Once you've loaded the package (`library(tidytransit)`), you can type `View(feedlist)` in your console. You'll be able to search for the name of the city or the name of the transit agency. `feedlist` has a column called `url_d` that you can use to download the GTFS feed. You can paste the url from that column into a web browser to download the file.

If you can't find the GTFS feed you need in the tidytransit feedlist or the OpenMobilityData site, you try looking at the transit agency's website. It will often be on a page called something like "Data for developers."

# Edit an OpenStreetMap network

If the alternative you want to evaluate involves changes to the road network, you'll need to save a copy of the existing OpenStreetMap network you downloaded (see the "Download and OpenStreetMap network" topic), and prepare it for editing (see the "Prepare an OpenStreetMap network for editing" topic).

You'll be editing using a Java application called JOSM (Java OpenStreetMap Editor). To run JOSM, you'll need to have Java SDK 11 installed on your computer. You can download it for free [here](https://www.oracle.com/java/technologies/downloads/#java11){target="_blank"} (it's possible you already have it on your computer if you've used the R5R package before).

You'll run JOSM from a JAR file that you can find in your GitHub repo (also downloadable from [here](https://josm.openstreetmap.de/){target="_blank"}). If you are working on a fairly small study area, you can just open it by double-clicking on it (this would be fine for Buffalo, I think). If you are working on a larger region, you'll probably need to increase the memory allocated to Java when you open it, so you should open it from the command line.

Once you've got the command line open, navigate to the folder where the JOSM jar file is saved (it's in the networks subfolder of your alternative folder of your GitHub repo / RStudio project directory). To do this, type `cd` followed by a space, then type the path to the networks subfolder the alternative folder in your GitHub repo. 

On a PC, if your study area is Richmond, it will probably be something like this:

`cd Documents\GitHub\Richmond\alternative\networks`

On a Mac, if will probably be something like this: 

`cd Richmond/alternative/networks`

Then type:

`java -jar -Xmx2g josm-tested.jar`

`java` means your opening an application with Java, `-jar` means its a JAR file, `-Xmx2g` allocates two gigabytes of memory to Java, and `josm-tested.jar` is the filename of the application you're opening. 

This will open JOSM on your computer. [Here's a video showing how to open JOSM on a Mac and what to do from there](https://harvard.zoom.us/rec/play/Jec7xZmMMMZ7cGTBCBCS0CJ0JPUxsCIZnlk43bERsicyCIZ68VcptBYPwgdv7mncLoKESvHwgs95zgl3.xcL9YPqQky9evdma?autoplay=true&startTime=1643383218000){target="_blank"}. [And here's the same thing on a PC](https://harvard.zoom.us/rec/play/1uCQQa5QYUVgcLVSB_cahuJR54AK4OyFYayVQG6wLMezbMeychrpN0zLbdl0UDwv92_LCF-2OlezjJVl.64uzqJOk4N-W15IR?autoplay=true&startTime=1643660096000){target="_blank"}.

# Edit transit route frequency

If the alternative you're proposing involves changes in the frequency of one or more transit routes, you can use the `scenRios` package to edit the frequency of a transit route in a GTFS feed.

First, you'll need to load the feed into your R environment using the `read_gtfs()` function in the `tidytransit` package.

```{r, warning=FALSE}
library(tidytransit)
library(here)

current_gtfs <- here("existing",
                     "networks",
                     "gtfs.zip") %>%
  read_gtfs()
```

Then you'll need to determine which route and service plan you want to edit. See the topics for "View GTFS routes" and "View GTFS service plans". 

Once you've identified a route and service plan, you can view the current headways using the 

```{r}
library(scenRios)

current_hdwys <- gtfs_get_hdwys(current_gtfs, 
                                        route = "19",
                                        service = "1")
kable(current_hdwys)
```
It looks like the current minimum headway is 30 minutes, and that headway stays consistent throughout most of the day (10am to 7:30pm in one direction and 9:15am to 6:45pm in the other).

You can use `gtfs_set_min_hdwy` to reduce headways proportionately throughout the service plan so that the minimum is 10 minutes.

```{r}
new_gtfs <- gtfs_set_min_hdwy(current_gtfs,
                              route = "19",
                              service = "1",
                              new_hdwy = 10)
```

As I've mentioned, the scenRios package is still in development, so it might not consistently work right. Let's see how it did.

```{r}
new_hdwys <- gtfs_get_hdwys(new_gtfs,
                            route = "19",
                            service = "1")

<<<<<<< HEAD
kable(new_hdwys)
=======

>>>>>>> 989886087ac62ac370dbc1a9decad7d92565d15a
```

The minimum headway is now 11 minutes - a little off due to rounding errors. If you want, you can go back and set the minimum headway to 9 minutes, and it will come out to ten minutes. Or who knows? Maybe I'll fix the scenRios package to work better before you start working on your assignment.

Once you've got the gtfs feed how you want it, you can write it to a file.

```{r}
new_gtfs_path <- here("alternative",
                      "networks",
                      "gtfs.zip")

write_gtfs(new_gtfs, new_gtfs_path)
```

# Generate skims

A skim is a matrix of travel times (or distances or costs) for all possible origin-destination pairs in your model. The R5R package is really useful for generating skims.

Before you load the r5r package, you'll need to increase the memory your computer allocates to Java.

```{r}
options(java.parameters = "-Xmx2G")

library(r5r)
```

```{r}

```


# Install a package from GitHub

If you want to edit the the transit network or the street network, you'll find the `scenRios` package useful. This is a package I wrote specifically for this class (like, yesterday), and it's still very much in beta. You'll need to install it from GitHub (this is common for beta versions of new or updated packages).

To install a package from GitHub, you can use the `install_github()` function in the `devtools` package, with the url for the repo where the package is. The repo for the scenRios package is at `https://github.com/c-voulgaris/scenRios`.

```{r, eval=FALSE}
library(devtools)

install_github("https://github.com/c-voulgaris/scenRios")
```


# Prepare an OpenStreetMap network for editing

The OSM file you download from the Overpass API (see the "Download an OpenStreetMap network" topic) will not include version tags, but to edit the file using JOSM (see the "Edit an OpenStreetMap network" topic), you'll need to have those.

The scenRios package includes a function called `osm_prep_network` that will add those for you. You'll need to load the contents of the file using `read_lines()`, then you can use `osm_prep_network()` to add the version tags, and then you can use `write_lines()` to save a modified version of the network that you can edit in JOSM.

```{r, eval=FALSE}
library(scenRios)
library(tidyverse)

old_network <- read_lines("existing/networks/streets.osm")

new_network <- osm_prep_network(old_network)

write_lines(new_network, 
            file = "alternative/networks/streets.osm")
```

# View GTFS routes

# View GTFS service plans
