---
title: "Assemble Household Data"
author: "Carole Voulgaris"
date: "1/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Required libraries

```{r, message=FALSE, warning=FALSE}
library(htmlwidgets)
library(knitr)
library(leaflet)
library(sf)
library(tidycensus)
library(tidytransit)
library(tidyverse)
library(tigris)
library(units)
```

# Overview

* Step 1: Define variables
* Step 2: Define study area boundary
* Step 3: Download zones and data
* Step 4: Summarize existing data
* Step 5: Map existing condition
* Step 6: Modify population data
* Step 7: Summarize alternative data
* Step 8: Map alternative condition

# Step 1: Define variables

```{r}
vars <- c(total_hhs = 'B08203_001',
          no_veh = 'B08203_002',
          lo_veh2w_1v = 'B08203_021',
          lo_veh3w_1v = 'B08203_027',
          lo_veh3w_2v = 'B08203_028',
          median_inc = 'B19013_001',
          hh_1person = 'B08201_007',
          hh_2person = 'B08201_013',
          hh_3person = 'B08201_019',
          hh_4person_fam = 'B11016_005',
          hh_4person_nfam = 'B11016_013',
          hh_5person_fam = 'B11016_006',
          hh_5person_nfam = 'B11016_014',
          hh_6person_fam = 'B11016_007',
          hh_6person_nfam = 'B11016_015',
          hh_7person_fam = 'B11016_008',
          hh_7person_nfam = 'B11016_016')


```

# Step 2: Define study area boundary

```{r}
boundary <- core_based_statistical_areas() %>%
  filter(GEOID == '40060') 
```

# Step 3: Download zones and data

```{r, message=FALSE, warning=FALSE}
zones <- get_acs(geography = "tract",
                 state = "VA",
                 variables = vars,
                 output = 'wide',
                 geometry = TRUE) %>%
  st_filter(boundary) 

zones <- zones %>%
  st_transform(2858) %>%
  mutate(area = set_units(st_area(zones), "mi2")) %>%
  mutate(hhs_mi2 = total_hhsE / area) %>%
  mutate(pct_no_veh = no_vehE / total_hhsE) %>%
  mutate(lo_veh = lo_veh2w_1vE +
                  lo_veh3w_1vE +
                  lo_veh3w_2vE) %>%
  mutate(hi_veh = total_hhsE - no_vehE - lo_veh) %>%
  mutate(pct_lo_veh = lo_veh / total_hhsE) %>%
  mutate(avg_hh_size = (hh_1personE +
                          2 * hh_2personE +
                          3 * hh_3personE +
                          4 * hh_4person_famE + 
                          4 * hh_4person_nfamE +
                          5 * hh_5person_famE +
                          5 * hh_5person_nfamE +
                          6 * hh_6person_famE +
                          6 * hh_6person_nfamE +
                          7 * hh_7person_famE +
                          7 * hh_7person_nfamE) / 
           total_hhsE) %>%
  rename(total_hhs = total_hhsE,
         median_inc = median_incE) %>%
  select(GEOID,
         total_hhs, 
         hhs_mi2, 
         pct_no_veh,
         pct_lo_veh, 
         median_inc, 
         avg_hh_size) %>%
  filter(total_hhs > 0)
```

# Step 4: Summarize existing data

```{r, warning=FALSE}
existing_summary <- as_tibble(rbind(summary(zones$total_hhs),
                                    summary(zones$pct_no_veh * 100),
                                    summary(zones$pct_lo_veh * 100),
                                    summary(zones$median_inc),
                                    summary(zones$avg_hh_size))) %>%
  mutate(Variable = c("Number of households",
                "Percent zero-vehicle households",
                "Percent vehicle-deficient households",
                "Median income",
                "Average household size")) %>%
  select(Variable, Min., Median, Mean, Max.)

kable(existing_summary, digits = 1)
```


# Step 5: Map existing condition

## Household density

```{r}
ggplot(zones) +
  geom_sf(color = NA,
          aes(fill = as.numeric(hhs_mi2))) +
  scale_fill_gradient(low = 'steelblue', 
                      high = 'orange',
                      trans = 'log',
                      breaks = c(1, 10, 100, 1000, 10000),
                      name = "Households per\nsquare mile") +
  theme_void()
```

## Median income

```{r}
ggplot(zones) +
  geom_sf(color = NA,
          aes(fill = median_inc)) +
  scale_fill_gradient(low = 'steelblue', 
                      high = 'orange',
                      name = "Median income",
                      breaks = breaks <- seq(50000, 
                                             250000, 
                                             by = 50000),
                      labels = paste("$", 
                                     formatC(breaks, format = "d",
                                               big.mark = ","),
                                     sep = "")) +
  theme_void()
```

## Percent zero-vehicle households

```{r}
ggplot(zones) +
  geom_sf(color = NA,
          aes(fill = pct_no_veh)) +
  scale_fill_gradient(low = 'steelblue', 
                      high = 'orange',
                      name = "Percent zero-vehicle\nhouseholds",
                      breaks = breaks <- seq(0, 
                                             1, 
                                             by = 0.1),
                      labels = paste(breaks * 100, "%",
                                     sep = "")) +
  theme_void()
```

# Percent vehicle-deficient households

```{r}
ggplot(zones) +
  geom_sf(color = NA,
          aes(fill = pct_lo_veh)) +
  scale_fill_gradient(low = 'steelblue', 
                      high = 'orange',
                      name = 
                        "Percent vehicle-\ndeficient\nhouseholds",
                      breaks = breaks <- seq(0, 
                                             0.2, 
                                             by = 0.05),
                      labels = paste(breaks * 100, "%",
                                     sep = "")) +
  theme_void()
```

## Household size

```{r}
ggplot(zones) +
  geom_sf(color = NA,
          aes(fill = avg_hh_size)) +
  scale_fill_gradient(low = 'steelblue', 
                      high = 'orange',
                      name = 
                        "Average\nhousehold\nsize") +
  theme_void()
```

# Step 6: Modify population data

## Increase population by ten percent

Note that we're assuming in this case that the median income, proportion of zero-vehicle households, and average household size are unchanged.

```{r}
new_zones <- zones %>%
  mutate(total_hhs = total_hhs * 1.1)
```

## View zone IDs on map

You might find it helpful to create an interactive map to find the GEOID of the zones where you want to make changes

```{r}
zones <- zones %>% 
  st_transform("WGS84")

map <- leaflet(zones) %>%
  addProviderTiles("Stamen.TonerLite") %>%
  addPolygons(popup = ~GEOID,
              weight = 1,
              opacity = 1,
              highlightOptions =
                highlightOptions(fillColor = "red"))

saveWidget(map, file = 'zones.html')
```

## Add a fixed number of zero-vehicle households

